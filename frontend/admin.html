<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>MoodSound íŒŒì¼ ì—…ë¡œë“œ (ê°œì„  UX + ë””ë²„ê·¸ë¡œê·¸)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; }
    h1 { margin-bottom: 20px; }
    .step { display: none; }
    .step.active { display: block; }
    fieldset { margin-bottom: 15px; }
    input[type="text"], input[type="file"] {
      padding: 5px; width: 300px;
    }
    button { padding: 6px 12px; margin-top: 10px; }
    .tag-list span {
      display:inline-block;
      background:#eee;
      padding:3px 8px;
      margin:3px;
      border-radius:4px;
    }
  </style>
</head>
<body>
  <h1>MoodSound íŒŒì¼ ì—…ë¡œë“œ</h1>

  <!-- Step 1 -->
  <div id="step1" class="step active">
    <label>íŒŒì¼ ì´ë¦„:
      <input type="text" id="name" placeholder="íŒŒì¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" required>
    </label><br><br>
    <label>íŒŒì¼ ì„ íƒ:
      <input type="file" id="file" accept=".mp3,.wav" required>
    </label>
    <br>
    <button onclick="nextStep(2)">ë‹¤ìŒ (íƒœê·¸ ì„ íƒ)</button>
  </div>

  <!-- Step 2 -->
  <div id="step2" class="step">
    <h3>ì¹´í…Œê³ ë¦¬ íƒœê·¸ ì„ íƒ</h3>
    <fieldset>
      <legend>í™˜ê²½ìŒ</legend>
      <label><input type="checkbox" value="ë„ì‹œ"> ë„ì‹œ</label>
      <label><input type="checkbox" value="ìì—°"> ìì—°</label>
      <label><input type="checkbox" value="ì‹¤ë‚´"> ì‹¤ë‚´</label>
      <label><input type="checkbox" value="ì‹¤ì™¸"> ì‹¤ì™¸</label>
    </fieldset>
    <fieldset>
      <legend>í–‰ë™</legend>
      <label><input type="checkbox" value="ê±¸ìŒ"> ê±¸ìŒ</label>
      <label><input type="checkbox" value="íƒ€ê²©"> íƒ€ê²©</label>
      <label><input type="checkbox" value="ë¬¸ë‹«ê¸°"> ë¬¸ë‹«ê¸°</label>
    </fieldset>
    <fieldset>
      <legend>ê°ì •</legend>
      <label><input type="checkbox" value="ê¸ì •"> ê¸ì •</label>
      <label><input type="checkbox" value="ë¶€ì •"> ë¶€ì •</label>
      <label><input type="checkbox" value="ì—†ìŒ"> ì—†ìŒ</label>
    </fieldset>
    <button onclick="nextStep(3)">ë‹¤ìŒ (ì˜ì„±ì–´/ì˜íƒœì–´ ì¶”ê°€)</button>
  </div>

  <!-- Step 3 -->
  <div id="step3" class="step">
    <h3>ì˜ì„±ì–´/ì˜íƒœì–´ ì¶”ê°€</h3>
    <p>ì—”í„°ë¡œ ì—¬ëŸ¬ ê°œë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    <input type="text" id="onomInput" placeholder="ì˜ˆ: ë¾°ë¡œë¡± ì…ë ¥ í›„ ì—”í„°">
    <div class="tag-list" id="onomList"></div>
    <button onclick="finish()">ì—…ë¡œë“œí•˜ê¸°</button>
  </div>

  <div id="result" style="margin-top:20px;font-weight:bold;"></div>

  <script>
    const steps = document.querySelectorAll('.step');
    function nextStep(num) {
      steps.forEach(s => s.classList.remove('active'));
      document.getElementById('step' + num).classList.add('active');
    }

    // ì˜ì„±ì–´/ì˜íƒœì–´ ê´€ë¦¬
    const onomInput = document.getElementById('onomInput');
    const onomList = document.getElementById('onomList');
    const customOnoms = [];

    onomInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const val = onomInput.value.trim();
        if (val && !customOnoms.includes(val)) {
          customOnoms.push(val);
          console.log("âœ… ì˜ì„±ì–´ ì¶”ê°€ë¨:", val, "í˜„ì¬ ëª©ë¡:", customOnoms);
          renderOnoms();
        }
        onomInput.value = '';
      }
    });

    function renderOnoms() {
      onomList.innerHTML = '';
      customOnoms.forEach(t => {
        const span = document.createElement('span');
        span.innerText = t;
        onomList.appendChild(span);
      });
    }

    async function finish() {
      const name = document.getElementById('name').value.trim();
      const file = document.getElementById('file').files[0];
      if (!name || !file) {
        alert('íŒŒì¼ ì´ë¦„ê³¼ íŒŒì¼ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      // ì²´í¬ëœ ì¹´í…Œê³ ë¦¬ íƒœê·¸
      const checked = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'));
      const catTags = checked.map(c => c.value);

      // ìµœì¢… íƒœê·¸ ë°°ì—´
      const allTags = [...catTags, ...customOnoms];

      // ğŸ“Œ ë””ë²„ê·¸ ë¡œê·¸
      console.log("=== [FRONTEND DEBUG] ì—…ë¡œë“œ ì „ì†¡ ===");
      console.log("íŒŒì¼ ì´ë¦„:", name);
      console.log("ì„ íƒëœ ì¹´í…Œê³ ë¦¬ íƒœê·¸(catTags):", catTags);
      console.log("ì¶”ê°€ëœ ì˜ì„±ì–´(customOnoms):", customOnoms);
      console.log("ìµœì¢… ì „ì†¡í•  allTags:", allTags);

      if (allTags.length === 0) {
        alert('ìµœì†Œ í•œ ê°œ ì´ìƒì˜ íƒœê·¸ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
        return;
      }

      const formData = new FormData();
      formData.append('name', name);
      formData.append('tags', allTags.join(',')); // ì‰¼í‘œë¡œ í•©ì¹¨
      formData.append('file', file);

      try {
        const res = await fetch('http://127.0.0.1:8000/api/sounds', {
          method: 'POST',
          body: formData
        });
        const data = await res.json();
        const result = document.getElementById('result');
        if (res.ok) {
          result.style.color = 'green';
          result.innerText = `âœ… ì—…ë¡œë“œ ì„±ê³µ! ID:${data.id}, ì´ë¦„:${data.name}`;
          console.log("âœ… [FRONTEND DEBUG] ì—…ë¡œë“œ ì‘ë‹µ:", data);
        } else {
          result.style.color = 'red';
          result.innerText = `âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: ${data.detail || JSON.stringify(data)}`;
          console.error("âŒ [FRONTEND DEBUG] ì—…ë¡œë“œ ì‹¤íŒ¨ ì‘ë‹µ:", data);
        }
      } catch (err) {
        const result = document.getElementById('result');
        result.style.color = 'red';
        result.innerText = `âš ï¸ ì—ëŸ¬ ë°œìƒ: ${err}`;
        console.error("âš ï¸ [FRONTEND DEBUG] ì—…ë¡œë“œ ì¤‘ ì—ëŸ¬:", err);
      }
    }
  </script>
</body>
</html>
