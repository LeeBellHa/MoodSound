<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>MoodSound ì‚¬ìš©ì í˜ì´ì§€</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; }
    h1 { margin-bottom: 20px; }
    label { display: block; margin-top: 15px; }
    input[type="text"], textarea {
      padding: 5px; width: 300px; margin-right: 10px;
    }
    button { padding: 6px 12px; margin-top: 5px; }
    ul { margin-top: 20px; padding-left: 0; list-style: none; }
    li { margin-bottom: 20px; }
    audio { display: block; margin-top: 5px; }
  </style>
</head>
<body>
  <h1>MoodSound ê²€ìƒ‰</h1>

  <!-- íƒœê·¸ë¡œ ì§ì ‘ ê²€ìƒ‰ -->
  <section>
    <h2>ğŸ” íƒœê·¸ë¡œ ê²€ìƒ‰</h2>
    <label>
      íƒœê·¸:
      <input type="text" id="tagInput" placeholder="ì˜ˆ: ë¬¼ë°©ìš¸">
    </label>
    <button id="searchTagBtn">ê²€ìƒ‰</button>
  </section>

  <!-- GPT ìƒí™©ìœ¼ë¡œ ê²€ìƒ‰ -->
  <section>
    <h2>âœ¨ ìƒí™©ìœ¼ë¡œ ê²€ìƒ‰ (GPT ì‚¬ìš©)</h2>
    <label>
      ìƒí™©:
      <textarea id="situationInput" rows="3" placeholder="ì˜ˆ: ë¹„ ì˜¤ëŠ” ë‚ ì— ë“£ê¸° ì¢‹ì€ ì†Œë¦¬"></textarea>
    </label>
    <button id="searchAiBtn">AIì—ê²Œ ì¶”ì²œë°›ê¸°</button>
  </section>

  <hr>

  <!-- ê²°ê³¼ -->
  <h2>ğŸ§ ê²€ìƒ‰ ê²°ê³¼</h2>
  <ul id="resultList"></ul>

  <script>
    const baseUrl = "http://127.0.0.1:8000";

    // ğŸŸ¢ íƒœê·¸ë¡œ ê²€ìƒ‰
    document.getElementById('searchTagBtn').addEventListener('click', async () => {
      const tag = document.getElementById('tagInput').value.trim();
      if (!tag) {
        alert('íƒœê·¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }
      await searchByTag(tag);
    });

    async function searchByTag(tag) {
      try {
        const res = await fetch(`${baseUrl}/api/sounds/search?tag=${encodeURIComponent(tag)}`);
        const data = await res.json();
        await renderResults(data);
      } catch (err) {
        console.error(err);
        alert("ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    }

    // ğŸŸ£ GPT ìƒí™©ìœ¼ë¡œ ê²€ìƒ‰
    document.getElementById('searchAiBtn').addEventListener('click', async () => {
      const prompt = document.getElementById('situationInput').value.trim();
      if (!prompt) {
        alert('ìƒí™©ì„ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }

      try {
        const res = await fetch(`${baseUrl}/api/sounds/ai_search`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt })
        });
        if (!res.ok) {
          const err = await res.json();
          alert("AI ê²€ìƒ‰ ì‹¤íŒ¨: " + (err.detail || res.statusText));
          return;
        }
        const data = await res.json();
        console.log("AI ì¶”ì²œ íƒœê·¸:", data.tags);
        await renderResults(data.results, data.tags);
      } catch (err) {
        console.error(err);
        alert("AI ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    });

    // ğŸ–¼ ê²°ê³¼ ë Œë”ë§ (Blob ì‚¬ìš©)
    async function renderResults(results, aiTags = null) {
      const list = document.getElementById('resultList');
      list.innerHTML = '';

      if (aiTags) {
        const tagInfo = document.createElement('li');
        tagInfo.style.color = 'green';
        tagInfo.innerText = `AI ì¶”ì²œ íƒœê·¸: ${aiTags.join(', ')}`;
        list.appendChild(tagInfo);
      }

      if (!results || results.length === 0) {
        const li = document.createElement('li');
        li.textContent = "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.";
        list.appendChild(li);
        return;
      }

      for (const item of results) {
        // íƒœê·¸ ë¬¸ìì—´ ë§Œë“¤ê¸°
        const tagNames = item.tags && Array.isArray(item.tags)
          ? item.tags.map(t => t.name).join(', ')
          : 'ì—†ìŒ';

        // ğŸ”¥ íŒŒì¼ fetch -> Blob URL ìƒì„±
        try {
          const audioRes = await fetch(`${baseUrl}/api/sounds/${item.id}`);
          const arrayBuffer = await audioRes.arrayBuffer();
          const blob = new Blob([arrayBuffer], { type: 'audio/mpeg' });
          const blobUrl = URL.createObjectURL(blob);

          const li = document.createElement('li');
          li.innerHTML = `
            <strong>${item.name}</strong> (íƒœê·¸: ${tagNames})
            <audio controls src="${blobUrl}"></audio>
          `;
          list.appendChild(li);
        } catch (err) {
          console.error("ì˜¤ë””ì˜¤ ë¡œë“œ ì˜¤ë¥˜:", err);
          const li = document.createElement('li');
          li.textContent = `ì˜¤ë””ì˜¤ ë¡œë“œ ì‹¤íŒ¨: ${item.name}`;
          list.appendChild(li);
        }
      }
    }
  </script>
</body>
</html>
